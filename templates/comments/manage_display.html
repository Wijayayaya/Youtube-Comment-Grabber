{% extends "admin/base_admin.html" %}
{% load static %}

{% block title %}Manage Display - YouTube Comment Grabber{% endblock %}

{% block content %}
<!-- [ breadcrumb ] start -->
<div class="page-header">
  <div class="page-block">
    <div class="row align-items-center">
      <div class="col-md-12">
        <div class="page-header-title">
          <h5 class="mb-0">Manage Display Comments</h5>
        </div>
      </div>
      <div class="col-md-12">
        <ul class="breadcrumb mb-0">
          <li class="breadcrumb-item"><a href="{% url 'comments:admin-dashboard' %}">Home</a></li>
          <li class="breadcrumb-item" aria-current="page">Manage Display</li>
        </ul>
      </div>
    </div>
  </div>
</div>
<!-- [ breadcrumb ] end -->

<!-- Rotation Settings -->
<div class="row">
  <div class="col-12">
    <div class="card">
      <div class="card-header">
        <h5>Display Settings</h5>
      </div>
      <div class="card-body">
        <div class="row align-items-center">
          <div class="col-md-4">
            <label for="rotation-seconds" class="form-label">Rotation seconds (applies to all messages)</label>
            <input id="rotation-seconds" name="seconds" type="number" min="1" class="form-control" value="{{ current_rotation_seconds|default:'' }}" />
          </div>
          <div class="col-md-2">
            <label class="form-label">&nbsp;</label>
            <button id="save-rotation" class="btn btn-primary w-100">
              <i class="feather icon-save"></i> Save Rotation
            </button>
          </div>
          <div class="col-md-6">
            <div class="alert alert-info mb-0">
              <i class="feather icon-info"></i> 
              This setting controls how long each comment is shown in the OBS display.
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Selected Messages -->
<div class="row">
  <div class="col-12">
    <div class="card">
      <div class="card-header">
        <h5>Selected Messages (All Streams)</h5>
        <p class="text-muted mb-0">Drag to reorder. Click <strong>Save Order</strong> to save the global order.</p>
      </div>
      <div class="card-body">
        <div class="table-responsive">
          <table id="messages-table" class="table table-hover">
            <thead>
              <tr>
                <th style="width: 100px">Order</th>
                <th>Author</th>
                <th>Message</th>
                <th>Stream</th>
              </tr>
            </thead>
            <tbody id="messages-list"></tbody>
          </table>
        </div>
        <div class="mt-3">
          <button id="save-order" class="btn btn-success">
            <i class="feather icon-save"></i> Save Order
          </button>
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
  const csrftoken = document.querySelector("input[name=csrfmiddlewaretoken]")?.value || null;

  function getCookie(name) {
    const value = `; ${document.cookie}`;
    const parts = value.split(`; ${name}=`);
    if (parts.length === 2) return parts.pop().split(";").shift();
  }

  const CSRF = csrftoken || getCookie("csrftoken");
  if (!CSRF) {
    console.error("CSRF token not found in DOM or cookies; API requests requiring CSRF protection may fail.");
  }

  function fetchMessages() {
    fetch('{% url "comments:manage-messages-api" %}')
      .then((r) => r.json())
      .then((data) => {
        const tbody = document.getElementById("messages-list");
        tbody.innerHTML = "";
        data.messages.forEach((m, idx) => {
          const tr = document.createElement("tr");
          tr.draggable = true;
          tr.dataset.id = m.id;
          tr.style.borderBottom = "1px solid #eee";
          tr.innerHTML = `
          <td style="padding:8px">${idx + 1}</td>
          <td style="padding:8px"><strong>${m.author}</strong></td>
          <td style="padding:8px">${m.text}</td>
          <td style="padding:8px">${m.live_stream_title || m.video_id || ""}</td>
        `;
          tbody.appendChild(tr);
        });
        attachDnD();
        // Refresh numbering after loading
        if (window._manageRefreshOrder) {
          window._manageRefreshOrder();
        }
      });
  }

  function attachDnD() {
    const list = document.getElementById("messages-list");
    let dragEl = null;

    function refreshOrderNumbers() {
      Array.from(list.querySelectorAll("tr")).forEach((r, i) => {
        const first = r.querySelector("td");
        if (first) first.textContent = i + 1;
      });
    }

    list.querySelectorAll("tr").forEach((row) => {
      row.addEventListener("dragstart", (e) => {
        dragEl = row;
        row.style.opacity = 0.5;
        e.dataTransfer.effectAllowed = "move";
      });
      row.addEventListener("dragend", (e) => {
        if (dragEl) dragEl.style.opacity = "";
        dragEl = null;
      });

      // More accurate dragover: decide insert before/after based on cursor position
      row.addEventListener("dragover", (e) => {
        e.preventDefault();
        if (!dragEl || row === dragEl) return;
        const rect = row.getBoundingClientRect();
        const offset = e.clientY - rect.top;
        const half = rect.height / 2;
        if (offset < half) {
          // insert before this row
          if (row.previousSibling !== dragEl) list.insertBefore(dragEl, row);
        } else {
          // insert after this row
          if (row.nextSibling !== dragEl) list.insertBefore(dragEl, row.nextSibling);
        }
      });

      row.addEventListener("drop", (e) => {
        e.preventDefault();
        if (!dragEl) return;
        // ensure visible order numbers update
        refreshOrderNumbers();
      });
    });

    // expose refresh to outer scope for initial numbering
    if (!window._manageRefreshOrder) window._manageRefreshOrder = refreshOrderNumbers;
    
    // Call refresh immediately to set initial numbers
    refreshOrderNumbers();
  }

  window.addEventListener("load", () => {
    fetchMessages();
  });

  document.getElementById("save-order").addEventListener("click", () => {
    const list = document.getElementById("messages-list");
    const ids = Array.from(list.querySelectorAll("tr")).map((tr) => parseInt(tr.dataset.id, 10));
    fetch('{% url "comments:manage-reorder-api" %}', {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        "X-CSRFToken": CSRF,
      },
      body: JSON.stringify({ order: ids }),
    })
      .then((r) => r.json())
      .then((js) => {
        if (js.status === "ok") alert("Order saved");
        else alert("Error");
      });
  });

  document.getElementById("save-rotation").addEventListener("click", () => {
    const seconds = document.getElementById("rotation-seconds").value;
    if (!seconds) {
      alert("Masukkan nilai detik");
      return;
    }
    const form = new FormData();
    form.append("seconds", seconds);
    fetch('{% url "comments:manage-update-rotation" %}', {
      method: "POST",
      headers: {
        "X-CSRFToken": CSRF,
      },
      body: form,
    })
      .then((r) => r.json())
      .then((js) => {
        if (js.status === "ok") alert("Rotation updated for " + js.updated_streams + " streams");
        else alert("Error");
      });
  });
</script>
{% endblock %}
