{% extends "base.html" %}
{% block title %}Live Chat{% endblock %}
{% block content %}
<h1 style="margin-top:0;">Live Chat Messages</h1>
<form method="get" class="filters">
    <input type="text" name="video_id" placeholder="Video ID" value="{{ active_filters.video_id }}">
    <select name="status">
        <option value="">Semua Status</option>
        {% for value,label in status_choices %}
            <option value="{{ value }}" {% if active_filters.status == value %}selected{% endif %}>{{ label }}</option>
        {% endfor %}
    </select>
    <input type="search" name="q" placeholder="Cari teks" value="{{ active_filters.q }}">
    <button type="submit">Filter</button>
</form>

<div style="overflow-x:auto;">
<table>
    <thead>
    <tr>
        <th>Waktu</th>
        <th>Video</th>
        <th>Author</th>
        <th>Pesan</th>
        <th>Status</th>
        <th>Catatan</th>
        <th>Aksi</th>
    </tr>
    </thead>
    <tbody>
    {% for message in object_list %}
        <tr>
            <td>{{ message.published_at|date:"d M H:i" }}</td>
            <td>{{ message.live_stream.video_id }}</td>
            <td>{{ message.author_name }}</td>
            <td>{{ message.message_text }}</td>
            <td><span class="badge {{ message.status }}">{{ message.get_status_display }}</span></td>
            <td>{{ message.note|default:"-" }}</td>
            <td>
                <form method="post" action="{% url 'comments:message-status' message.pk %}" class="inline">
                    {% csrf_token %}
                    <select name="status">
                        {% for value,label in status_choices %}
                            <option value="{{ value }}" {% if message.status == value %}selected{% endif %}>{{ label }}</option>
                        {% endfor %}
                    </select>
                    <input type="text" name="note" placeholder="Catatan" value="{{ message.note }}">
                    <button type="submit">Simpan</button>
                </form>
                <button type="button" class="send-obs" data-id="{{ message.pk }}" style="margin-left:0.5rem;">Kirim ke OBS</button>
            </td>
        </tr>
    {% empty %}
        <tr><td colspan="7" style="text-align:center;">Belum ada data.</td></tr>
    {% endfor %}
    </tbody>
</table>
</div>

{% if is_paginated %}
<div style="margin-top:1rem; display:flex; gap:0.5rem;">
    {% if page_obj.has_previous %}
        <a href="?page={{ page_obj.previous_page_number }}{% if query_without_page %}&{{ query_without_page }}{% endif %}">Sebelumnya</a>
    {% endif %}
    <span>Halaman {{ page_obj.number }} / {{ page_obj.paginator.num_pages }}</span>
    {% if page_obj.has_next %}
        <a href="?page={{ page_obj.next_page_number }}{% if query_without_page %}&{{ query_without_page }}{% endif %}">Selanjutnya</a>
    {% endif %}
</div>
{% endif %}

<script>
// Get CSRF token from cookie
function getCookie(name) {
    const value = `; ${document.cookie}`;
    const parts = value.split(`; ${name}=`);
    if (parts.length === 2) return parts.pop().split(';').shift();
}

document.querySelectorAll('.send-obs').forEach(function(btn) {
    btn.addEventListener('click', function() {
        const id = this.dataset.id;
        if (!confirm('Kirim pesan ini ke OBS?')) return;
        const csrftoken = getCookie('csrftoken');
        fetch(`/api/messages/${id}/send-to-obs/`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrftoken,
            },
            body: JSON.stringify({}),
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === 'ok') {
                alert('Pesan dikirim ke OBS');
            } else {
                alert('Gagal mengirim ke OBS: ' + (data.message || JSON.stringify(data)));
            }
        })
        .catch(err => {
            alert('Terjadi kesalahan saat mengirim ke OBS');
            console.error(err);
        });
    });
});
</script>

{% endblock %}
